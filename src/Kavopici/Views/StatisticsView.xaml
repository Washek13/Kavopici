<UserControl x:Class="Kavopici.Views.StatisticsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:components="clr-namespace:Kavopici.Components"
             xmlns:converters="clr-namespace:Kavopici.Converters"
             Loaded="OnLoaded">

    <UserControl.Resources>
        <converters:NotNullToVisibilityConverter x:Key="NotNullToVis" />
        <converters:RoastLevelToStringConverter x:Key="RoastLevelConverter" />
        <converters:DoubleToIntConverter x:Key="DoubleToInt" />
        <converters:TabIndexConverter x:Key="TabIndexConv" />
        <converters:TabIndexToVisibilityConverter x:Key="TabToVis" />
        <converters:DateOnlyToStringConverter x:Key="DateConverter" />
    </UserControl.Resources>

    <DockPanel>
        <!-- Header -->
        <Border DockPanel.Dock="Top" Style="{StaticResource HeaderPanel}">
            <Grid>
                <TextBlock Text="STATISTIKY" Style="{StaticResource TitleStyle}"
                           VerticalAlignment="Center" />
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <Button Content="POROVNAT SMĚSI"
                            Command="{Binding NavigateToComparisonCommand}"
                            Style="{StaticResource PrimaryButton}"
                            Foreground="White" BorderBrush="White"
                            Margin="0,0,8,0" />
                    <Button Content="← ZPĚT" Command="{Binding GoBackCommand}"
                            Style="{StaticResource PrimaryButton}"
                            Foreground="White" BorderBrush="White" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- Tab bar -->
        <Border DockPanel.Dock="Top" Background="{StaticResource CreamBrush}"
                BorderBrush="{StaticResource SilverBrush}" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" Margin="20,0">
                <RadioButton Content="VŠECHNY SMĚSI"
                             Style="{StaticResource TabRadioButton}"
                             IsChecked="{Binding SelectedTabIndex, Converter={StaticResource TabIndexConv}, ConverterParameter=0}" />
                <RadioButton Content="MOJE HODNOCENÍ"
                             Style="{StaticResource TabRadioButton}"
                             IsChecked="{Binding SelectedTabIndex, Converter={StaticResource TabIndexConv}, ConverterParameter=1}" />
            </StackPanel>
        </Border>

        <!-- Error message -->
        <TextBlock DockPanel.Dock="Bottom" Text="{Binding ErrorMessage}"
                   Style="{StaticResource ErrorStyle}"
                   Margin="20,8" TextWrapping="Wrap"
                   Visibility="{Binding ErrorMessage, Converter={StaticResource NotNullToVis}}" />

        <!-- Tab 0: All blends -->
        <Grid Margin="20"
              Visibility="{Binding SelectedTabIndex, Converter={StaticResource TabToVis}, ConverterParameter=0}">
            <DataGrid ItemsSource="{Binding BlendStats}" Style="{StaticResource CoffeeDataGrid}"
                      ColumnHeaderStyle="{StaticResource CoffeeColumnHeader}"
                      RowStyle="{StaticResource CoffeeDataGridRow}"
                      CellStyle="{StaticResource CoffeeDataGridCell}">
                <DataGrid.InputBindings>
                    <MouseBinding MouseAction="LeftDoubleClick"
                                  Command="{Binding NavigateToDetailCommand}"
                                  CommandParameter="{Binding SelectedItem, RelativeSource={RelativeSource AncestorType=DataGrid}}" />
                </DataGrid.InputBindings>
                <DataGrid.Columns>
                    <DataGridTextColumn Header="NÁZEV SMĚSI" Binding="{Binding BlendName}" Width="*">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontWeight" Value="Bold" />
                                <Setter Property="Cursor" Value="Hand" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTemplateColumn Header="PRŮMĚR" Width="160" SortMemberPath="AverageRating">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                    <components:StarRatingControl Rating="{Binding AverageRating, Converter={StaticResource DoubleToInt}}"
                                                                   IsReadOnly="True" StarSize="14" />
                                    <TextBlock Text="{Binding AverageRating, StringFormat='{}{0:F1}'}"
                                               Style="{StaticResource BodyStyle}"
                                               Margin="8,0,0,0" VerticalAlignment="Center" />
                                </StackPanel>
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="POČET" Binding="{Binding RatingCount}" Width="80" />
                    <DataGridTextColumn Header="PRAŽÍRNA" Binding="{Binding Roaster}" Width="120" />
                    <DataGridTextColumn Header="DODAVATEL" Binding="{Binding SupplierName}" Width="120" />
                </DataGrid.Columns>
            </DataGrid>
        </Grid>

        <!-- Tab 1: My ratings -->
        <Grid Margin="20"
              Visibility="{Binding SelectedTabIndex, Converter={StaticResource TabToVis}, ConverterParameter=1}">
            <DataGrid ItemsSource="{Binding UserRatings}" Style="{StaticResource CoffeeDataGrid}"
                      ColumnHeaderStyle="{StaticResource CoffeeColumnHeader}"
                      RowStyle="{StaticResource CoffeeDataGridRow}"
                      CellStyle="{StaticResource CoffeeDataGridCell}">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="DATUM" Binding="{Binding Session.Date, Converter={StaticResource DateConverter}}" Width="100" />
                    <DataGridTextColumn Header="SMĚS" Binding="{Binding Blend.Name}" Width="*">
                        <DataGridTextColumn.ElementStyle>
                            <Style TargetType="TextBlock">
                                <Setter Property="FontWeight" Value="Bold" />
                            </Style>
                        </DataGridTextColumn.ElementStyle>
                    </DataGridTextColumn>
                    <DataGridTemplateColumn Header="HODNOCENÍ" Width="120" SortMemberPath="Stars">
                        <DataGridTemplateColumn.CellTemplate>
                            <DataTemplate>
                                <components:StarRatingControl Rating="{Binding Stars}"
                                                               IsReadOnly="True" StarSize="14"
                                                               VerticalAlignment="Center" />
                            </DataTemplate>
                        </DataGridTemplateColumn.CellTemplate>
                    </DataGridTemplateColumn>
                    <DataGridTextColumn Header="KOMENTÁŘ" Binding="{Binding Comment}" Width="*" />
                </DataGrid.Columns>
            </DataGrid>
        </Grid>
    </DockPanel>
</UserControl>
