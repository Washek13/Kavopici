<UserControl x:Class="Kavopici.Views.BlendDetailView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:components="clr-namespace:Kavopici.Components"
             xmlns:converters="clr-namespace:Kavopici.Converters"
             Loaded="OnLoaded">

    <UserControl.Resources>
        <converters:NotNullToVisibilityConverter x:Key="NotNullToVis" />
        <converters:RoastLevelToStringConverter x:Key="RoastLevelConverter" />
        <converters:DoubleToIntConverter x:Key="DoubleToInt" />
        <converters:DateOnlyToStringConverter x:Key="DateConverter" />
    </UserControl.Resources>

    <DockPanel>
        <!-- Header -->
        <Border DockPanel.Dock="Top" Style="{StaticResource HeaderPanel}">
            <Grid>
                <TextBlock Text="DETAIL SMĚSI" Style="{StaticResource TitleStyle}"
                           VerticalAlignment="Center" />
                <Button Content="← ZPĚT" Command="{Binding GoBackCommand}"
                        Style="{StaticResource PrimaryButton}"
                        Foreground="White" BorderBrush="White"
                        HorizontalAlignment="Right" VerticalAlignment="Center" />
            </Grid>
        </Border>

        <!-- Error message -->
        <TextBlock DockPanel.Dock="Bottom" Text="{Binding ErrorMessage}"
                   Style="{StaticResource ErrorStyle}"
                   Margin="20,8" TextWrapping="Wrap"
                   Visibility="{Binding ErrorMessage, Converter={StaticResource NotNullToVis}}" />

        <!-- Content -->
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <StackPanel Margin="20">
                <!-- Blend info card -->
                <Border Style="{StaticResource PanelBorder}" Margin="0,0,0,20">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="{Binding BlendStats.BlendName}"
                                       Style="{StaticResource HeadingStyle}"
                                       Margin="0,0,0,4" />
                            <TextBlock Style="{StaticResource BodyStyle}" Margin="0,0,0,4">
                                <Run Text="Pražírna: " FontWeight="Bold" />
                                <Run Text="{Binding BlendStats.Roaster, Mode=OneWay}" />
                            </TextBlock>
                            <TextBlock Style="{StaticResource BodyStyle}" Margin="0,0,0,4"
                                       Visibility="{Binding BlendStats.Origin, Converter={StaticResource NotNullToVis}}">
                                <Run Text="Původ: " FontWeight="Bold" />
                                <Run Text="{Binding BlendStats.Origin, Mode=OneWay}" />
                            </TextBlock>
                            <TextBlock Style="{StaticResource BodyStyle}" Margin="0,0,0,4">
                                <Run Text="Stupeň pražení: " FontWeight="Bold" />
                                <Run Text="{Binding BlendStats.RoastLevel, Converter={StaticResource RoastLevelConverter}, Mode=OneWay}" />
                            </TextBlock>
                            <TextBlock Style="{StaticResource BodyStyle}">
                                <Run Text="Dodavatel: " FontWeight="Bold" />
                                <Run Text="{Binding BlendStats.SupplierName, Mode=OneWay}" />
                            </TextBlock>
                        </StackPanel>

                        <!-- Summary stats -->
                        <StackPanel Grid.Column="1" VerticalAlignment="Top" Margin="20,0,0,0"
                                    MinWidth="160" HorizontalAlignment="Center">
                            <TextBlock Text="CELKOVÉ HODNOCENÍ" Style="{StaticResource LabelStyle}"
                                       Margin="0,0,0,8" HorizontalAlignment="Center" />
                            <components:StarRatingControl
                                Rating="{Binding BlendStats.AverageRating, Converter={StaticResource DoubleToInt}}"
                                IsReadOnly="True" StarSize="28"
                                HorizontalAlignment="Center"
                                Margin="0,0,0,4" />
                            <TextBlock Text="{Binding BlendStats.AverageRating, StringFormat='{}{0:F1} / 5'}"
                                       Style="{StaticResource BodyStyle}"
                                       HorizontalAlignment="Center"
                                       FontSize="16" FontWeight="Bold"
                                       Margin="0,0,0,4" />
                            <TextBlock Style="{StaticResource LabelStyle}"
                                       HorizontalAlignment="Center">
                                <Run Text="{Binding BlendStats.RatingCount, Mode=OneWay}" />
                                <Run Text=" hodnocení" />
                            </TextBlock>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Distribution chart -->
                <Border Style="{StaticResource PanelBorder}" Margin="0,0,0,20">
                    <StackPanel>
                        <TextBlock Text="ROZLOŽENÍ HODNOCENÍ" Style="{StaticResource LabelStyle}"
                                   Margin="0,0,0,12" />
                        <ItemsControl ItemsSource="{Binding DistributionBars}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="50" />
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="40" />
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Grid.Column="0" Text="{Binding Label}"
                                                   Style="{StaticResource BodyStyle}"
                                                   VerticalAlignment="Center" />
                                        <Border Grid.Column="1" Height="20"
                                                Background="{StaticResource SilverBrush}"
                                                CornerRadius="0" Margin="8,0">
                                            <Border Background="{StaticResource AmberGoldBrush}"
                                                    CornerRadius="0"
                                                    HorizontalAlignment="Left"
                                                    Width="{Binding BarWidth}" />
                                        </Border>
                                        <TextBlock Grid.Column="2" Text="{Binding Count}"
                                                   Style="{StaticResource BodyStyle}"
                                                   VerticalAlignment="Center"
                                                   HorizontalAlignment="Right" />
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>

                <!-- Individual ratings -->
                <Border Style="{StaticResource PanelBorder}">
                    <StackPanel>
                        <TextBlock Text="JEDNOTLIVÁ HODNOCENÍ" Style="{StaticResource LabelStyle}"
                                   Margin="0,0,0,12" />
                        <ItemsControl ItemsSource="{Binding Ratings}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderBrush="{StaticResource SilverBrush}"
                                            BorderThickness="0,0,0,1"
                                            Padding="0,8"
                                            Margin="0,0,0,4">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="120" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Grid.Column="0">
                                                <TextBlock Text="{Binding User.Name}"
                                                           Style="{StaticResource BodyStyle}"
                                                           FontWeight="Bold" />
                                                <TextBlock Text="{Binding Session.Date, Converter={StaticResource DateConverter}}"
                                                           Style="{StaticResource LabelStyle}"
                                                           FontSize="10" />
                                            </StackPanel>
                                            <components:StarRatingControl Grid.Column="1"
                                                Rating="{Binding Stars}"
                                                IsReadOnly="True" StarSize="14"
                                                VerticalAlignment="Center"
                                                Margin="8,0" />
                                            <TextBlock Grid.Column="2"
                                                       Text="{Binding Comment}"
                                                       Style="{StaticResource BodyStyle}"
                                                       TextWrapping="Wrap"
                                                       VerticalAlignment="Center"
                                                       Visibility="{Binding Comment, Converter={StaticResource NotNullToVis}}" />
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </StackPanel>
                </Border>
            </StackPanel>
        </ScrollViewer>
    </DockPanel>
</UserControl>
