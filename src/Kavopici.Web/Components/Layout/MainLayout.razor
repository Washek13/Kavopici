@inherits LayoutComponentBase
@inject AppState AppState
@inject UpdateState UpdateState
@inject IUpdateService UpdateService
@inject NavigationManager Nav

<div class="app-container">
    @if (UpdateState.IsUpdateAvailable)
    {
        <div class="update-banner">
            <div class="update-banner-content">
                <span class="update-banner-version">Je dostupn치 nov치 verze @UpdateState.AvailableUpdate!.Version.</span>
                @if (!string.IsNullOrWhiteSpace(UpdateState.AvailableUpdate!.ReleaseNotes))
                {
                    <div class="update-banner-notes">
                        @UpdateState.AvailableUpdate.ReleaseNotes
                    </div>
                }
            </div>
            @if (isDownloading)
            {
                <span>Stahov치n칤...</span>
            }
            else
            {
                <button class="btn btn-sm" style="background:var(--amber-gold);color:var(--coffee-dark);margin-left:12px;" @onclick="InstallUpdate">
                    Aktualizovat
                </button>
            }
        </div>
    }

    @if (AppState.IsLoggedIn)
    {
        <header class="app-header">
            <div class="header-brand" @onclick="GoToDashboard">
                <img src="icon-32.png" alt="" class="header-icon" />
                K츼VOP칈캛I
            </div>
            <nav class="header-nav">
                <button class="nav-btn" @onclick="GoToDashboard">N치st캩nka</button>
                <button class="nav-btn" @onclick="GoToStatistics">Statistiky</button>
                @if (AppState.IsAdmin)
                {
                    <button class="nav-btn" @onclick="GoToAdmin">Spr치va</button>
                }
            </nav>
            <div class="header-user">
                <UserInitials Name="@AppState.CurrentUser!.Name" />
                <span class="user-name">@AppState.CurrentUser!.Name</span>
                <a href="@BugReportUrl" target="_blank" rel="noopener noreferrer"
                   class="btn btn-sm" title="Nahl치sit chybu"
                   style="text-decoration:none;font-size:16px;line-height:1;">
                    游
                </a>
                <button class="btn btn-sm" @onclick="Logout">Odhl치sit</button>
            </div>
        </header>
    }

    <main class="app-main">
        @Body
    </main>
</div>

@code {
    private bool isDownloading;

    protected override void OnInitialized()
    {
        AppState.OnChange += StateHasChanged;
        UpdateState.OnChange += OnUpdateStateChanged;
    }

    private void OnUpdateStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task InstallUpdate()
    {
        if (UpdateState.AvailableUpdate is null) return;
        isDownloading = true;
        await UpdateService.DownloadAndInstallUpdateAsync(UpdateState.AvailableUpdate);
    }

    private void GoToDashboard() => Nav.NavigateTo("/dashboard");
    private void GoToStatistics() => Nav.NavigateTo("/statistics");
    private void GoToAdmin() => Nav.NavigateTo("/admin");

    private void Logout()
    {
        AppState.Logout();
        Nav.NavigateTo("/");
    }

    private const string GitHubOwner = "Washek13";
    private const string GitHubRepo = "Kavopici";

    private string BugReportUrl => BuildBugReportUrl();

    private string BuildBugReportUrl()
    {
        var version = System.Reflection.Assembly.GetExecutingAssembly()
            .GetName().Version?.ToString() ?? "unknown";

        var body = "## Popis chyby\n<!-- Popi코te, co se stalo -->\n\n"
            + "## Kroky k reprodukci\n1.\n2.\n3.\n\n"
            + "## O캜ek치van칠 chov치n칤\n<!-- Co jste o캜ek치vali? -->\n\n"
            + "## Skute캜n칠 chov치n칤\n<!-- Co se stalo m칤sto toho? -->\n\n"
            + "---\n"
            + $"**Verze aplikace:** {version}";

        var encodedBody = Uri.EscapeDataString(body);
        return $"https://github.com/{GitHubOwner}/{GitHubRepo}/issues/new?labels=bug&body={encodedBody}";
    }

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
        UpdateState.OnChange -= OnUpdateStateChanged;
    }
}
