@inherits LayoutComponentBase
@inject AppState AppState
@inject UpdateState UpdateState
@inject IUpdateService UpdateService
@inject NavigationManager Nav

<div class="app-container">
    @if (UpdateState.IsUpdateAvailable)
    {
        <div class="update-banner">
            <span>Je dostupná nová verze @UpdateState.AvailableUpdate!.Version.</span>
            @if (isDownloading)
            {
                <span>Stahování...</span>
            }
            else
            {
                <button class="btn btn-sm" style="background:var(--amber-gold);color:var(--coffee-dark);margin-left:12px;" @onclick="InstallUpdate">
                    Aktualizovat
                </button>
            }
        </div>
    }

    @if (AppState.IsLoggedIn)
    {
        <header class="app-header">
            <div class="header-brand" @onclick="GoToDashboard">KAVOPICI</div>
            <nav class="header-nav">
                <button class="nav-btn" @onclick="GoToDashboard">Nástěnka</button>
                <button class="nav-btn" @onclick="GoToStatistics">Statistiky</button>
                @if (AppState.IsAdmin)
                {
                    <button class="nav-btn" @onclick="GoToAdmin">Správa</button>
                }
            </nav>
            <div class="header-user">
                <UserInitials Name="@AppState.CurrentUser!.Name" />
                <span class="user-name">@AppState.CurrentUser!.Name</span>
                <button class="btn btn-sm" @onclick="Logout">Odhlásit</button>
            </div>
        </header>
    }

    <main class="app-main">
        @Body
    </main>
</div>

@code {
    private bool isDownloading;

    protected override void OnInitialized()
    {
        AppState.OnChange += StateHasChanged;
        UpdateState.OnChange += OnUpdateStateChanged;
    }

    private void OnUpdateStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private async Task InstallUpdate()
    {
        if (UpdateState.AvailableUpdate is null) return;
        isDownloading = true;
        await UpdateService.DownloadAndInstallUpdateAsync(UpdateState.AvailableUpdate);
    }

    private void GoToDashboard() => Nav.NavigateTo("/dashboard");
    private void GoToStatistics() => Nav.NavigateTo("/statistics");
    private void GoToAdmin() => Nav.NavigateTo("/admin");

    private void Logout()
    {
        AppState.Logout();
        Nav.NavigateTo("/");
    }

    public void Dispose()
    {
        AppState.OnChange -= StateHasChanged;
        UpdateState.OnChange -= OnUpdateStateChanged;
    }
}
