@page "/statistics"
@inject IStatisticsService StatisticsService
@inject ICsvExportService CsvExportService
@inject AppState AppState
@inject NavigationManager Nav
@inject IJSRuntime JS

@if (!AppState.IsLoggedIn) { Nav.NavigateTo("/"); return; }

<h1>Statistiky</h1>

@if (errorMessage != null)
{
    <div class="msg-error">@errorMessage</div>
}

<div class="tab-bar">
    <button class="tab-btn @(tab == 0 ? "active" : "")" @onclick="() => tab = 0">Přehled směsí</button>
    <button class="tab-btn @(tab == 1 ? "active" : "")" @onclick="() => tab = 1">Moje hodnocení</button>
    <button class="tab-btn @(tab == 2 ? "active" : "")" @onclick="() => tab = 2">Přehled dodavatelů</button>
</div>

@if (isLoading)
{
    <div class="loading">Načítání...</div>
}
else if (tab == 0)
{
    <div class="flex items-center justify-between mb-16">
        <div class="btn-group">
            <button class="btn btn-outline" @onclick="GoToComparison">Porovnání směsí</button>
            <button class="btn btn-outline" @onclick="ExportCsv">Export CSV</button>
        </div>
    </div>

    @if (blendStats.Count == 0)
    {
        <div class="panel text-center">
            <p class="text-muted">Zatím žádné statistiky.</p>
        </div>
    }
    else
    {
        <table class="data-table">
            <thead>
                <tr>
                    <th @onclick="@(() => SortBy("BlendName"))">Směs</th>
                    <th @onclick="@(() => SortBy("AverageRating"))">Průměr</th>
                    <th @onclick="@(() => SortBy("RatingCount"))">Počet</th>
                    <th @onclick="@(() => SortBy("Roaster"))">Pražírna</th>
                    <th @onclick="@(() => SortBy("SupplierName"))">Dodavatel</th>
                    <th @onclick="@(() => SortBy("PricePerKg"))">Cena/kg</th>
                    <th @onclick="@(() => SortBy("ControversyLevel"))">Kontroverznost</th>
                    <th @onclick="@(() => SortBy("PricePerformance"))">Cena/★</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var stat in blendStats)
                {
                    <tr style="cursor:pointer;" @onclick="@(() => GoToBlendDetail(stat.BlendId))">
                        <td><strong>@stat.BlendName</strong></td>
                        <td>
                            <span style="color:var(--amber-gold);font-weight:600;">
                                @(stat.RatingCount > 0 ? stat.AverageRating.ToString("F1") : "—")
                            </span>
                            @if (stat.RatingCount > 0)
                            {
                                <span> &#9733;</span>
                            }
                        </td>
                        <td>@stat.RatingCount</td>
                        <td>@stat.Roaster</td>
                        <td>@stat.SupplierName</td>
                        <td>@(stat.PricePerKg.HasValue ? $"{stat.PricePerKg.Value:F0} Kč" : "—")</td>
                        <td><ControversyBadge Level="stat.ControversyLevel" ShowDash="true" /></td>
                        <td>@(stat.PricePerformance.HasValue ? $"{stat.PricePerformance.Value:F0} Kč/★" : "—")</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}
else if (tab == 1)
{
    @if (userSessions.Count == 0)
    {
        <div class="panel text-center">
            <p class="text-muted">Zatím žádná degustace.</p>
        </div>
    }
    else
    {
        <table class="data-table">
            <thead>
                <tr>
                    <th>Datum</th>
                    <th>Směs</th>
                    <th>Poznámka</th>
                    <th>Hodnocení</th>
                    <th>Komentář</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in userSessions)
                {
                    var sessionId = item.Session.Id;
                    var isRevealed = item.HasRated || revealedSessions.Contains(sessionId);
                    var isExpanded = expandedSessions.Contains(sessionId);

                    <tr>
                        <td>@item.Session.Date.ToString("d. M. yyyy")</td>
                        <td>
                            @if (isRevealed)
                            {
                                <strong>@item.Session.Blend.Name</strong>
                            }
                            else
                            {
                                <em class="text-muted">Tajné hlasování</em>
                            }
                        </td>
                        <td class="text-muted">@(item.Session.Comment ?? "—")</td>
                        <td>
                            @if (item.HasRated)
                            {
                                <span style="color:var(--amber-gold);">
                                    @(new string('\u2605', item.UserRating!.Stars))@(new string('\u2606', MaxStars - item.UserRating!.Stars))
                                </span>
                            }
                            else if (!isExpanded)
                            {
                                <button class="btn btn-outline btn-sm" @onclick="() => ExpandRatingForm(sessionId)">
                                    Ohodnotit
                                </button>
                            }
                        </td>
                        <td class="text-muted">@(item.HasRated ? (item.UserRating!.Comment ?? "—") : "—")</td>
                    </tr>

                    @if (!item.HasRated && isExpanded)
                    {
                        <tr>
                            <td colspan="5" class="inline-rating-cell">
                                <div class="inline-rating-form">
                                    <RatingForm SessionId="@sessionId"
                                                BlendId="@item.Session.BlendId"
                                                OnRatingSubmitted="() => OnRetroRatingSubmitted(sessionId)" />
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    }
}
else if (tab == 2)
{
    @if (supplierStats.Count == 0)
    {
        <div class="panel text-center">
            <p class="text-muted">Zatím žádní dodavatelé.</p>
        </div>
    }
    else
    {
        <table class="data-table">
            <thead>
                <tr>
                    <th @onclick="@(() => SortSupplierBy("SupplierName"))">Dodavatel</th>
                    <th @onclick="@(() => SortSupplierBy("TotalSessionCount"))">Celkem</th>
                    <th @onclick="@(() => SortSupplierBy("Last30DaysSessionCount"))">Posledních 30 dní</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var stat in supplierStats)
                {
                    <tr>
                        <td><strong>@stat.SupplierName</strong></td>
                        <td>@stat.TotalSessionCount</td>
                        <td>@stat.Last30DaysSessionCount</td>
                    </tr>
                }
            </tbody>
        </table>
    }
}

@code {
    private const int MaxStars = 5;

    private int tab;
    private List<BlendStatistics> blendStats = new();
    private List<SessionWithRating> userSessions = new();
    private List<SupplierStatistics> supplierStats = new();
    private HashSet<int> expandedSessions = new();
    private HashSet<int> revealedSessions = new();
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (!AppState.IsLoggedIn) return;

        // Check for tab query parameter
        var uri = new Uri(Nav.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        if (query["tab"] == "ratings")
            tab = 1;
        else if (query["tab"] == "suppliers")
            tab = 2;

        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            blendStats = await StatisticsService.GetBlendStatisticsAsync();
            supplierStats = await StatisticsService.GetSupplierStatisticsAsync();

            if (AppState.CurrentUser != null)
                userSessions = await StatisticsService.GetUserSessionHistoryAsync(AppState.CurrentUser.Id);
        }
        catch (Exception ex) { errorMessage = ex.Message; }
        finally { isLoading = false; }
    }

    private void ExpandRatingForm(int sessionId)
    {
        expandedSessions.Add(sessionId);
    }

    private async Task OnRetroRatingSubmitted(int sessionId)
    {
        revealedSessions.Add(sessionId);
        expandedSessions.Remove(sessionId);

        // Reload to update the rated status
        if (AppState.CurrentUser != null)
            userSessions = await StatisticsService.GetUserSessionHistoryAsync(AppState.CurrentUser.Id);
    }

    private void SortBy(string column)
    {
        blendStats = column switch
        {
            "BlendName" => blendStats.OrderBy(s => s.BlendName).ToList(),
            "AverageRating" => blendStats.OrderByDescending(s => s.AverageRating).ToList(),
            "RatingCount" => blendStats.OrderByDescending(s => s.RatingCount).ToList(),
            "Roaster" => blendStats.OrderBy(s => s.Roaster).ToList(),
            "SupplierName" => blendStats.OrderBy(s => s.SupplierName).ToList(),
            "PricePerKg" => blendStats.OrderByDescending(s => s.PricePerKg ?? 0).ToList(),
            "ControversyLevel" => blendStats.OrderByDescending(s => s.ControversyLevel ?? -1).ToList(),
            "PricePerformance" => blendStats.OrderBy(s => s.PricePerformance ?? decimal.MaxValue).ToList(),
            _ => blendStats
        };
    }

    private void SortSupplierBy(string column)
    {
        supplierStats = column switch
        {
            "SupplierName" => supplierStats.OrderBy(s => s.SupplierName).ToList(),
            "TotalSessionCount" => supplierStats.OrderByDescending(s => s.TotalSessionCount).ToList(),
            "Last30DaysSessionCount" => supplierStats.OrderByDescending(s => s.Last30DaysSessionCount).ToList(),
            _ => supplierStats
        };
    }

    private void GoToComparison() => Nav.NavigateTo("/comparison");
    private void GoToBlendDetail(int blendId) => Nav.NavigateTo($"/blend/{blendId}");

    private async Task ExportCsv()
    {
        try
        {
            errorMessage = null;
            var bytes = await CsvExportService.GenerateCsvBytesAsync();
            var fileName = $"kavopici_export_{DateTime.Now:yyyy-MM-dd}.csv";
            await JS.InvokeVoidAsync("downloadFile", fileName, "text/csv", bytes);
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }
}
