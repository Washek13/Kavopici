@page "/dashboard"
@inject ISessionService SessionService
@inject IRatingService RatingService
@inject IStatisticsService StatisticsService
@inject AppState AppState
@inject NavigationManager Nav

@if (!AppState.IsLoggedIn) { Nav.NavigateTo("/"); return; }

<h1>Nástěnka</h1>

@if (errorMessage != null)
{
    <div class="msg-error">@errorMessage</div>
}

@* Highlights *@
@if (hasHighlights)
{
    <div class="highlights">
        <div class="highlight-card clickable" @onclick="GoToTopBlend">
            <div class="highlight-label">Nejlépe hodnocená</div>
            <div class="highlight-value">@topBlendName</div>
            <div class="highlight-sub">@topBlendRating.ToString("F1") &#9733;</div>
        </div>
        <div class="highlight-card clickable" @onclick="GoToStatistics">
            <div class="highlight-label">Vaše hodnocení</div>
            <div class="highlight-value">@userRatingCount</div>
            <div class="highlight-sub">celkem hodnocení</div>
        </div>
    </div>
}

@* Flavor Wheel Banner *@
<div class="flavor-wheel-banner">
    <div class="banner-content">
        <span class="banner-icon">☕</span>
        <span class="banner-text">Nejste si jisti chutí? Podívejte se na kolečko chutí kávy</span>
        <a href="https://notbadcoffee.com/flavor-wheel-en/"
           target="_blank"
           rel="noopener noreferrer"
           class="btn btn-outline btn-sm">
            Otevřít kolečko chutí
        </a>
    </div>
</div>

@* Blend of the Day *@
@if (isLoading)
{
    <div class="loading">Načítání...</div>
}
else if (todaySession != null)
{
    <div class="card">
        <h2>Káva dne — @todaySession.Date.ToString("d. M. yyyy")</h2>

        @if (showTodaySecret)
        {
            <div class="secret-overlay">
                <h3>Tajné hlasování</h3>
                <p>Ohodnoťte kávu před odhalením detailů.</p>
            </div>
        }
        else
        {
            <div class="blend-card-wrapper clickable" @onclick="GoToTodayBlend">
                <BlendCard Blend="todaySession.Blend" SessionComment="@todaySession.Comment" />
            </div>
        }

        <div class="mt-16">
            <RatingForm SessionId="@todaySession.Id"
                        BlendId="@todaySession.BlendId"
                        ExistingRating="@existingRating"
                        OnRatingSubmitted="OnTodayRatingSubmitted" />
        </div>
    </div>
}
else if (missedSession != null)
{
    <div class="card">
        <h2>Zmeškané hodnocení — @missedSession.Date.ToString("d. M. yyyy")</h2>

        @if (!missedSessionRevealed)
        {
            <div class="secret-overlay">
                <h3>Tajné hlasování</h3>
                <p>Ohodnoťte kávu před odhalením detailů.</p>
            </div>
        }
        else
        {
            <div class="blend-card-wrapper clickable" @onclick="GoToMissedBlend">
                <BlendCard Blend="missedSession.Blend" SessionComment="@missedSession.Comment" />
            </div>
        }

        <div class="mt-16">
            <RatingForm SessionId="@missedSession.Id"
                        BlendId="@missedSession.BlendId"
                        OnRatingSubmitted="OnMissedRatingSubmitted" />
        </div>
    </div>
}
else
{
    <div class="panel text-center">
        <h2>Dnes žádná káva</h2>
        <p class="text-muted">Administrátor dosud nenastavil dnešní směs.</p>
    </div>
}

@code {
    private TastingSession? todaySession;
    private TastingSession? missedSession;
    private Rating? existingRating;
    private bool todayBlendRevealed;
    private bool missedSessionRevealed;
    private bool isLoading = true;

    private string? topBlendName;
    private double topBlendRating;
    private int topBlendId;
    private int userRatingCount;
    private bool hasHighlights;

    private string? errorMessage;

    private bool showTodaySecret => todaySession != null && !todayBlendRevealed;

    protected override async Task OnInitializedAsync()
    {
        if (!AppState.IsLoggedIn) return;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            todaySession = await SessionService.GetTodaySessionAsync();

            if (todaySession != null && AppState.CurrentUser != null)
            {
                existingRating = await RatingService.GetUserRatingForSessionAsync(
                    AppState.CurrentUser.Id, todaySession.Id);

                if (existingRating != null)
                {
                    todayBlendRevealed = true;
                    var noteIds = await RatingService.GetRatingNoteIdsAsync(existingRating.Id);
                    existingRating.RatingTastingNotes = noteIds.Select(id =>
                        new RatingTastingNote { RatingId = existingRating.Id, TastingNoteId = id }).ToList();
                }
                else
                {
                    todayBlendRevealed = false;
                }
            }
            else if (todaySession == null && AppState.CurrentUser != null)
            {
                missedSession = await SessionService.GetMostRecentUnratedSessionAsync(AppState.CurrentUser.Id);
            }

            // Highlights
            var stats = await StatisticsService.GetBlendStatisticsAsync();
            if (stats.Count > 0)
            {
                var top = stats.OrderByDescending(s => s.AverageRating).First();
                topBlendName = top.BlendName;
                topBlendRating = top.AverageRating;
                topBlendId = top.BlendId;

                if (AppState.CurrentUser != null)
                {
                    var history = await StatisticsService.GetUserRatingHistoryAsync(AppState.CurrentUser.Id);
                    userRatingCount = history.Count;
                }
                hasHighlights = true;
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnTodayRatingSubmitted()
    {
        todayBlendRevealed = true;
    }

    private void OnMissedRatingSubmitted()
    {
        missedSessionRevealed = true;
    }

    private void GoToTopBlend() => Nav.NavigateTo($"/blend/{topBlendId}");
    private void GoToTodayBlend() => Nav.NavigateTo($"/blend/{todaySession!.BlendId}");
    private void GoToMissedBlend() => Nav.NavigateTo($"/blend/{missedSession!.BlendId}");
    private void GoToStatistics() => Nav.NavigateTo("/statistics?tab=ratings");
}
