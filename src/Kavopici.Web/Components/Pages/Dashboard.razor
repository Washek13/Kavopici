@page "/dashboard"
@inject ISessionService SessionService
@inject IRatingService RatingService
@inject IStatisticsService StatisticsService
@inject AppState AppState
@inject NavigationManager Nav

@if (!AppState.IsLoggedIn) { Nav.NavigateTo("/"); return; }

<h1>Nástěnka</h1>

@if (errorMessage != null)
{
    <div class="msg-error">@errorMessage</div>
}

@* Highlights *@
@if (hasHighlights)
{
    <div class="highlights">
        <div class="highlight-card clickable" @onclick="GoToTopBlend">
            <div class="highlight-label">Nejlépe hodnocená</div>
            <div class="highlight-value">@topBlendName</div>
            <div class="highlight-sub">@topBlendRating.ToString("F1") &#9733;</div>
        </div>
        <div class="highlight-card clickable" @onclick="GoToStatistics">
            <div class="highlight-label">Vaše hodnocení</div>
            <div class="highlight-value">@userRatingCount</div>
            <div class="highlight-sub">celkem hodnocení</div>
        </div>
    </div>
}

@* Blends of the Day *@
@if (isLoading)
{
    <div class="loading">Načítání...</div>
}
else if (todaySessions.Count > 0)
{
    @foreach (var session in todaySessions)
    {
        var sessionId = session.Id;
        var isRevealed = revealedSessionIds.Contains(sessionId);
        var existing = existingRatings.GetValueOrDefault(sessionId);

        <div class="card">
            <h2>Káva dne — @session.Date.ToString("d. M. yyyy")</h2>

            @if (!isRevealed)
            {
                <div class="secret-overlay">
                    <h3>Tajné hlasování</h3>
                    @if (!string.IsNullOrEmpty(session.Comment))
                    {
                        <p style="font-size:1.1em;font-weight:600;margin:8px 0;">@session.Comment</p>
                    }
                    <p>Ohodnoťte kávu před odhalením detailů.</p>
                </div>
            }
            else
            {
                <div class="blend-card-wrapper clickable" @onclick="() => GoToBlend(session.BlendId)">
                    <BlendCard Blend="session.Blend" SessionComment="@session.Comment" />
                </div>
            }

            <div class="mt-16">
                <RatingForm SessionId="@sessionId"
                            BlendId="@session.BlendId"
                            ExistingRating="@existing"
                            OnRatingSubmitted="() => OnTodayRatingSubmitted(sessionId)" />
            </div>
        </div>
    }
}
else if (missedSessions.Count > 0)
{
    @foreach (var session in missedSessions)
    {
        var sessionId = session.Id;
        var isRevealed = revealedMissedSessionIds.Contains(sessionId);

        <div class="card">
            <h2>Zmeškané hodnocení — @session.Date.ToString("d. M. yyyy")</h2>

            @if (!isRevealed)
            {
                <div class="secret-overlay">
                    <h3>Tajné hlasování</h3>
                    @if (!string.IsNullOrEmpty(session.Comment))
                    {
                        <p style="font-size:1.1em;font-weight:600;margin:8px 0;">@session.Comment</p>
                    }
                    <p>Ohodnoťte kávu před odhalením detailů.</p>
                </div>
            }
            else
            {
                <div class="blend-card-wrapper clickable" @onclick="() => GoToBlend(session.BlendId)">
                    <BlendCard Blend="session.Blend" SessionComment="@session.Comment" />
                </div>
            }

            <div class="mt-16">
                <RatingForm SessionId="@sessionId"
                            BlendId="@session.BlendId"
                            OnRatingSubmitted="() => OnMissedRatingSubmitted(sessionId)" />
            </div>
        </div>
    }
}
else
{
    <div class="panel text-center">
        <h2>Dnes žádná káva</h2>
        <p class="text-muted">Administrátor dosud nenastavil dnešní směs.</p>
    </div>
}

@* Flavor Wheel Banner *@
<a href="https://notbadcoffee.com/flavor-wheel-en/"
   target="_blank"
   rel="noopener noreferrer"
   class="flavor-wheel-banner">
    <div class="banner-content">
        <span class="banner-icon">☕</span>
        <span class="banner-text">Nejste si jisti chutí? Podívejte se na kolečko chutí kávy</span>
    </div>
</a>

@code {
    private List<TastingSession> todaySessions = new();
    private List<TastingSession> missedSessions = new();
    private Dictionary<int, Rating?> existingRatings = new();
    private HashSet<int> revealedSessionIds = new();
    private HashSet<int> revealedMissedSessionIds = new();
    private bool isLoading = true;

    private string? topBlendName;
    private double topBlendRating;
    private int topBlendId;
    private int userRatingCount;
    private bool hasHighlights;

    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (!AppState.IsLoggedIn) return;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            todaySessions = await SessionService.GetTodaySessionsAsync();

            if (todaySessions.Count > 0 && AppState.CurrentUser != null)
            {
                foreach (var session in todaySessions)
                {
                    var rating = await RatingService.GetUserRatingForSessionAsync(
                        AppState.CurrentUser.Id, session.Id);

                    existingRatings[session.Id] = rating;

                    if (rating != null)
                    {
                        revealedSessionIds.Add(session.Id);
                        var noteIds = await RatingService.GetRatingNoteIdsAsync(rating.Id);
                        rating.RatingTastingNotes = noteIds.Select(id =>
                            new RatingTastingNote { RatingId = rating.Id, TastingNoteId = id }).ToList();
                    }
                }
            }
            else if (todaySessions.Count == 0 && AppState.CurrentUser != null)
            {
                missedSessions = await SessionService.GetMostRecentUnratedSessionsAsync(AppState.CurrentUser.Id);
            }

            // Highlights
            var stats = await StatisticsService.GetBlendStatisticsAsync();
            if (stats.Count > 0)
            {
                var top = stats.OrderByDescending(s => s.AverageRating).First();
                topBlendName = top.BlendName;
                topBlendRating = top.AverageRating;
                topBlendId = top.BlendId;

                if (AppState.CurrentUser != null)
                {
                    var history = await StatisticsService.GetUserRatingHistoryAsync(AppState.CurrentUser.Id);
                    userRatingCount = history.Count;
                }
                hasHighlights = true;
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void OnTodayRatingSubmitted(int sessionId)
    {
        revealedSessionIds.Add(sessionId);
    }

    private void OnMissedRatingSubmitted(int sessionId)
    {
        revealedMissedSessionIds.Add(sessionId);
    }

    private void GoToTopBlend() => Nav.NavigateTo($"/blend/{topBlendId}");
    private void GoToBlend(int blendId) => Nav.NavigateTo($"/blend/{blendId}");
    private void GoToStatistics() => Nav.NavigateTo("/statistics?tab=ratings");
}
