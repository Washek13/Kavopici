@page "/blend/{BlendId:int}"
@inject IStatisticsService StatisticsService
@inject IRatingService RatingService
@inject AppState AppState
@inject NavigationManager Nav

@if (!AppState.IsLoggedIn) { Nav.NavigateTo("/"); return; }

@if (errorMessage != null)
{
    <div class="msg-error">@errorMessage</div>
}

@if (isLoading)
{
    <div class="loading">Načítání...</div>
}
else if (blendStats == null)
{
    <div class="panel text-center">
        <p class="text-muted">Směs nenalezena.</p>
    </div>
}
else
{
    <div class="card">
        <h1>@blendStats.BlendName</h1>
        <div class="blend-details mb-16">
            <div class="blend-detail"><span class="label">Pražírna:</span> @blendStats.Roaster</div>
            @if (!string.IsNullOrEmpty(blendStats.Origin))
            {
                <div class="blend-detail"><span class="label">Původ:</span> @blendStats.Origin</div>
            }
            <div class="blend-detail"><span class="label">Pražení:</span> @blendStats.RoastLevel.ToDisplayString()</div>
            <div class="blend-detail"><span class="label">Dodavatel:</span> @blendStats.SupplierName</div>
            @if (blendStats.PricePerKg.HasValue)
            {
                <div class="blend-detail"><span class="label">Cena/kg:</span> @blendStats.PricePerKg.Value.ToString("F0") Kč</div>
            }
            @if (blendStats.PricePerformance.HasValue)
            {
                <div class="blend-detail"><span class="label">Cena/★:</span> @blendStats.PricePerformance.Value.ToString("F0") Kč</div>
            }
        </div>

        <div class="flex items-center gap-8 mb-16">
            <span style="font-size:36px;color:var(--amber-gold);font-family:Georgia,serif;">
                @(blendStats.RatingCount > 0 ? blendStats.AverageRating.ToString("F1") : "—")
            </span>
            @if (blendStats.RatingCount > 0)
            {
                <span style="font-size:24px;color:var(--amber-gold);">&#9733;</span>
            }
            <span class="text-muted">(@blendStats.RatingCount hodnocení)</span>
            <ControversyBadge Level="blendStats.ControversyLevel" />
        </div>

        @* Distribution *@
        @if (blendStats.RatingCount > 0)
        {
            <h3>Rozložení hodnocení</h3>
            var maxCount = blendStats.Distribution.Max();
            @for (int i = 4; i >= 0; i--)
            {
                var count = blendStats.Distribution[i];
                var widthPct = maxCount > 0 ? (count / (double)maxCount) * 100 : 0;
                <div class="distribution-row">
                    <span class="distribution-label">@(i + 1) &#9733;</span>
                    <div class="distribution-bar-bg">
                        <div class="distribution-bar" style="@($"width:{widthPct:F0}%")"></div>
                    </div>
                    <span class="distribution-count">@count</span>
                </div>
            }
        }
    </div>

    @* Individual ratings *@
    <h2 class="mt-16">Jednotlivá hodnocení</h2>
    @if (ratings.Count == 0)
    {
        <div class="panel text-center">
            <p class="text-muted">Zatím žádná hodnocení.</p>
        </div>
    }
    else
    {
        @foreach (var r in ratings)
        {
            <div class="card">
                <div class="flex items-center gap-8 mb-8">
                    <UserInitials Name="@r.User.Name" Size="32" />
                    <strong>@r.User.Name</strong>
                    <span class="text-muted" style="margin-left:auto;font-size:13px;">
                        @r.CreatedAt.ToLocalTime().ToString("d. M. yyyy HH:mm")
                    </span>
                </div>
                <StarRating Value="@r.Stars" ReadOnly="true" />
                @if (!string.IsNullOrEmpty(r.Comment))
                {
                    <p class="mt-8" style="font-style:italic;color:var(--coffee-medium);">@r.Comment</p>
                }
                @if (r.RatingTastingNotes.Count > 0)
                {
                    <div class="tasting-notes mt-8">
                        @foreach (var rtn in r.RatingTastingNotes)
                        {
                            <span class="note-tag selected readonly">@rtn.TastingNote.Name</span>
                        }
                    </div>
                }
            </div>
        }
    }
}

@code {
    [Parameter] public int BlendId { get; set; }

    private BlendStatistics? blendStats;
    private List<Rating> ratings = new();
    private bool isLoading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (!AppState.IsLoggedIn) return;
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var allStats = await StatisticsService.GetBlendStatisticsAsync();
            blendStats = allStats.FirstOrDefault(s => s.BlendId == BlendId);
            ratings = await RatingService.GetRatingsForBlendAsync(BlendId);
        }
        catch (Exception ex) { errorMessage = ex.Message; }
        finally { isLoading = false; }
    }

}
