@page "/comparison"
@inject IStatisticsService StatisticsService
@inject AppState AppState
@inject NavigationManager Nav

@if (!AppState.IsLoggedIn) { Nav.NavigateTo("/"); return; }

<h1>Porovnání směsí</h1>

@if (errorMessage != null)
{
    <div class="msg-error">@errorMessage</div>
}

@if (isLoading)
{
    <div class="loading">Načítání...</div>
}
else
{
    <div class="comparison-grid">
        @* Blend A *@
        <div>
            <div class="form-group">
                <label>Směs A</label>
                <select @bind="blendAId">
                    <option value="0">— vyberte —</option>
                    @foreach (var b in allBlends)
                    {
                        <option value="@b.BlendId">@b.BlendName (@b.Roaster)</option>
                    }
                </select>
            </div>

            @if (BlendA != null)
            {
                <div class="card">
                    <h3>@BlendA.BlendName</h3>
                    <div class="blend-details mb-8">
                        <div class="blend-detail"><span class="label">Pražírna:</span> @BlendA.Roaster</div>
                        <div class="blend-detail"><span class="label">Dodavatel:</span> @BlendA.SupplierName</div>
                    </div>
                    <div class="flex items-center gap-8 mb-8">
                        <span style="font-size:28px;color:var(--amber-gold);font-family:Georgia,serif;">
                            @(BlendA.RatingCount > 0 ? BlendA.AverageRating.ToString("F1") : "—")
                        </span>
                        @if (BlendA.RatingCount > 0) { <span style="color:var(--amber-gold);">&#9733;</span> }
                        <span class="text-muted">(@BlendA.RatingCount)</span>
                    </div>
                    @RenderDistribution(BlendA)
                </div>
            }
        </div>

        @* Blend B *@
        <div>
            <div class="form-group">
                <label>Směs B</label>
                <select @bind="blendBId">
                    <option value="0">— vyberte —</option>
                    @foreach (var b in allBlends)
                    {
                        <option value="@b.BlendId">@b.BlendName (@b.Roaster)</option>
                    }
                </select>
            </div>

            @if (BlendB != null)
            {
                <div class="card">
                    <h3>@BlendB.BlendName</h3>
                    <div class="blend-details mb-8">
                        <div class="blend-detail"><span class="label">Pražírna:</span> @BlendB.Roaster</div>
                        <div class="blend-detail"><span class="label">Dodavatel:</span> @BlendB.SupplierName</div>
                    </div>
                    <div class="flex items-center gap-8 mb-8">
                        <span style="font-size:28px;color:var(--amber-gold);font-family:Georgia,serif;">
                            @(BlendB.RatingCount > 0 ? BlendB.AverageRating.ToString("F1") : "—")
                        </span>
                        @if (BlendB.RatingCount > 0) { <span style="color:var(--amber-gold);">&#9733;</span> }
                        <span class="text-muted">(@BlendB.RatingCount)</span>
                    </div>
                    @RenderDistribution(BlendB)
                </div>
            }
        </div>
    </div>
}

@code {
    private List<BlendStatistics> allBlends = new();
    private int blendAId;
    private int blendBId;
    private bool isLoading = true;
    private string? errorMessage;

    private BlendStatistics? BlendA => allBlends.FirstOrDefault(b => b.BlendId == blendAId);
    private BlendStatistics? BlendB => allBlends.FirstOrDefault(b => b.BlendId == blendBId);

    protected override async Task OnInitializedAsync()
    {
        if (!AppState.IsLoggedIn) return;
        try
        {
            allBlends = await StatisticsService.GetBlendStatisticsAsync();
        }
        catch (Exception ex) { errorMessage = ex.Message; }
        finally { isLoading = false; }
    }

    private RenderFragment RenderDistribution(BlendStatistics stats) => __builder =>
    {
        if (stats.RatingCount == 0) return;
        var maxCount = stats.Distribution.Max();
        for (int i = 4; i >= 0; i--)
        {
            var count = stats.Distribution[i];
            var widthPct = maxCount > 0 ? (count / (double)maxCount) * 100 : 0;
            <div class="distribution-row">
                <span class="distribution-label">@(i + 1) &#9733;</span>
                <div class="distribution-bar-bg">
                    <div class="distribution-bar" style="@($"width:{widthPct:F0}%")"></div>
                </div>
                <span class="distribution-count">@count</span>
            </div>
        }
    };
}
